@model webapp.ViewModels.AuxiliarEdit
@{
    ViewBag.Title = "Plantilla";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Theme JS files -->
<script type="text/javascript" src="~/assets/js/core/app.js"></script>
<script type="text/javascript" src="~/assets/js/plugins/forms/validation/validate.min.js"></script>
<script type="text/javascript" src="~/assets/js/core/libraries/jquery_ui/interactions.min.js"></script>
<script type="text/javascript" src="~/assets/js/plugins/tables/datatables/datatables.min.js"></script>
<script type="text/javascript" src="~/assets/js/plugins/forms/selects/select2.min.js"></script>
<script type="text/javascript" src="~/assets/js/pages/form_select2.js"></script>

<script type="text/javascript" src="~/assets/js/plugins/tables/handsontable/handsontable.min.js"></script>
<!--<script type="text/javascript" src="~/assets/js/plugins/ui/prism.min.js"></script>-->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<!-- /theme JS files -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.8/jquery.inputmask.min.js"></script>



@section Styles{
    <style>
        .datatable-header {
            display: none;
        }

        table.dataTable thead tr {
            background-color: #3f444e;
            color: white;
        }

        #EstructuraModal thead tr, #CargaDatatable thead tr {
            background-color: #3f444e;
            color: white;
        }

        .modal {
            text-align: center;
            padding: 0 !important;
        }

            .modal:before {
                content: '';
                display: inline-block;
                height: 100%;
                vertical-align: middle;
                margin-right: -4px;
            }

        .modal-dialog {
            display: inline-block;
            text-align: left;
            vertical-align: middle;
        }

        .ui-autocomplete {
            z-index: 215000000 !important;
        }

        .select2-no-results {
            display: none !important;
        }



        #hot_alignment .ht_master.handsontable {
            overflow: visible;
        }

        #hot_alignment {
            overflow-x: auto;
            display: block;
        }

            #hot_alignment .wtHolder {
                width: auto !important;
                height: auto !important;
            }

        .htColumnHL {
            overflow-wrap: break-word;
            writing-mode: vertical-rl;
            /*transform: scale(-1);*/
        }

        .tblx, .tblx th, .tblx td {
            border: 1px solid;
        }

        .headerTblColorPlomo {
            background-color: #55585A;
            color: white;
            border-color: #55585A;
        }

            .headerTblColorPlomo th {
                border-color: #55585A !important;
            }

        .colorBeige {
            background-color: #969076;
            color: white;
        }

        .colorGray {
            background-color: #F2F2F2;
        }

        .colorPlomo {
            background-color: #55585A;
            color: white;
        }

        .tblRowsHeight tr {
            line-height: 15px;
            min-height: 15px;
            height: 15px;
        }

        .tblRowsHeight th, td {
            padding: 5px !important;
        }

        .borderWhite {
            border-color: white;
        }

        .icon-custom-style {
            font-size: 25px !important;
            cursor: pointer;
        }

        .tab-content > .tab-pane {
            display: block !important;
            height: 0 !important;
            overflow: hidden !important;
        }

            .tab-content > .tab-pane.active {
                height: auto !important;
            }
        canvas{
            max-width: 720px;
        }
    </style>
}

<!-- Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Seleccionar Escenario</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th align="center"># Esc</th>
                            <th align="center">Cliente</th>
                            <th align="center">Operacion</th>
                            <th align="center">Producto</th>
                            <th align="center">Monto</th>
                            <th align="center">Tea</th>
                            <th align="center">Plazo</th>
                            <th align="center">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td align="center">01</td>
                            <td align="left">DNI: 72843916</td>
                            <td align="left">Depósito</td>
                            <td align="left">Vista</td>
                            <td align="right">1,000,00.00 USD</td>
                            <td align="center">10.00%</td>
                            <td align="center">24 meses</td>
                            <td align="center">
                                <a data-dismiss="modal">Seleccionar</a>
                            </td>
                        </tr>
                        <tr>
                            <td align="center">02</td>
                            <td align="left">RUC: 12345678910</td>
                            <td align="left">Directo</td>
                            <td align="left">Tarjeta Negocio</td>
                            <td align="right">2,000,00.00 USD</td>
                            <td align="center">10.00%</td>
                            <td align="center">24 meses</td>
                            <td align="center">
                                <a data-dismiss="modal">Seleccionar</a>
                            </td>
                        </tr>
                        <tr>
                            <td align="center">03</td>
                            <td align="left">RUC: 12345678910</td>
                            <td align="left">Directo</td>
                            <td align="left">Descuento</td>
                            <td align="right">2,000,00.00 USD</td>
                            <td align="center">10.00%</td>
                            <td align="center">24 meses</td>
                            <td align="center">
                                <a data-dismiss="modal">Seleccionar</a>
                            </td>
                        </tr>
                        <tr>
                            <td align="center">04</td>
                            <td align="left">RUC: 12345678910</td>
                            <td align="left">Directo</td>
                            <td align="left">Otros Créditos</td>
                            <td align="right">2,000,00.00 USD</td>
                            <td align="center">10.00%</td>
                            <td align="center">24 meses</td>
                            <td align="center">
                                <a data-dismiss="modal">Seleccionar</a>
                            </td>
                        </tr>
                        <tr>
                            <td align="center">05</td>
                            <td align="left">DNI: 72843916</td>
                            <td align="left">Indirecto</td>
                            <td align="left">Carta Fianza</td>
                            <td align="right">1,000,00.00 USD</td>
                            <td align="center">10.00%</td>
                            <td align="center">24 meses</td>
                            <td align="center">
                                <a data-dismiss="modal">Seleccionar</a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <!--<button type="button" class="btn btn-primary"></button>-->
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<div class="container-fluid">
    <!-- Page header -->
    <!--
    <div class="page-header">
        <div class="page-header-content">
        </div>
        <div class="breadcrumb-line breadcrumb-line-component">
            <ul class="breadcrumb">
                <li><a href="@Url.Action("Index","Home")"><i class="icon-home2 position-left"></i> Simulador</a></li>
            </ul>
        </div>
    </div>-->
    <!-- /page header -->
    <!-- Content area -->
    <div class="content" style="padding-top:0px;">
        <!-- Vertical form options -->
        <div class="row">
            <div class="col-md-12">
                <!-- Basic layout-->
                <div class="panel panel-flat">
                    <div class="panel-heading">
                        <i class="icon-file-empty position-left icon-custom-style" id="btnNuevo"></i>
                        <i class="icon-pencil position-left icon-custom-style" id="btnEditar"></i>
                        <i class="icon-floppy-disk position-left icon-custom-style" id="btnGrabar"></i>
                        <!--<i class="icon-envelop4 position-left" style="font-size:25px"></i>-->
                        <div class="heading-elements">
                            
                            <!--<ul class="icons-list">
                            <li><a data-action="collapse"></a></li>
                            <li><a data-action="reload"></a></li>
                            <li><a data-action="close"></a></li>
                                                    </ul>-->
                        </div>
                    </div>

                    <div class="panel-body">


                        <div class="row">
                            
                            <div class="col-md-5" style="border-right: 1px solid #e8e7e7;">
                                <fieldset>
                                    <legend class="tipografia1 text-semibold"><i class="icon-user-tie position-left"></i> Detalle del Cliente o Prospecto</legend>
                                    <form id="FormSim">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label class="radio-inline">
                                                        <input type="radio" name="rbTipProspecto" value="1" checked="checked">
                                                        Cliente
                                                    </label>

                                                    <label class="radio-inline">
                                                        <input type="radio" name="rbTipProspecto" value="2">
                                                        Prospecto
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>Nombre o Razón Social</label>
                                                    <input type="text" id="txtNombreCliente" name="txtNombreCliente" class="form-control">
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>Personería</label>
                                                    @Html.DropDownList("ddlPersoneria", Model.ddlPersoneria, new { @class = "select" })
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label>Tip. Doc.</label>
                                                    @Html.DropDownList("ddlTipDocumento", Model.ddlTipDocumento, new { @class = "select" })
                                                </div>
                                            </div>

                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label>Número Doc.</label>
                                                    <input type="text" id="txtNumDoc" name="txtNumDoc" class="form-control">
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>Tipo Cliente:</label>
                                                    @Html.DropDownList("ddlTipCliente", Model.ddlTipCliente, new { @class = "select" })
                                                </div>
                                            </div>
                                        </div>

                                        <legend class="tipografia1 text-semibold"><i class=" icon-cash3 position-left"></i> Detalle de la Operación</legend>

                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Operación:</label>
                                                    @Html.DropDownList("ddlOperacion", Model.ddlOperacion, new { @class = "select" })
                                                </div>
                                            </div>

                                            <div class="col-md-5">
                                                <div class="form-group">
                                                    <label>Producto:</label>
                                                    @Html.DropDownList("ddlProducto", Model.ddlProducto, new { @class = "select" })
                                                </div>
                                            </div>

                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label>Moneda:</label>
                                                    @Html.DropDownList("ddlMoneda", Model.ddlMoneda, new { @class = "select" })
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-5">
                                                <div class="form-group">
                                                    <label>Amortización</label>
                                                    <input type="text" id="txtAmortizacion" value="@Model.amortizacion.Text" class="form-control" readonly />
                                                    <!--
            <select id="ddlAmortizacion" name="ddlAmortizacion" class="select" disabled>
                <option value="1">Cuotas Constantes</option>
                <option value="2">Amortización de intereses y capital al vencimiento</option>
                <option value="3">Revolventes</option>
                <option value="4">Descuentos</option>
                <option value="5">Interes y capital al vencimiento</option>
                <option value="6"></option>
            </select>
                -->
                                                </div>
                                            </div>

                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Monto:</label>
                                                    <input type="text" id="txtMonto" name="txtMonto" min="0" value="0" class="form-control">
                                                </div>
                                            </div>

                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label>Canal:</label>
                                                    @Html.DropDownList("ddlCanalAtencion", Model.ddlCanalAtencion, new { @class = "select" })
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>Tasa Efectiva (Anual)</label>
                                                    <div class="input-group">
                                                        <input type="text" id="txtTasaEfectiva" name="txtTasaEfectiva" value="0" class="form-control">
                                                        <span class="input-group-addon">%</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>Plazo en meses</label>
                                                    <input type="text" id="txtPlazoMeses" name="txtPlazoMeses" onkeypress="return event.charCode >= 48 && event.charCode <= 57" min="1" max="99" maxlength="2" step="1" value="12" class="form-control">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>Clasificación Interna</label>
                                                    @Html.DropDownList("ddlClasificacionInterna", Model.ddlClasificacionInterna, new { @class = "select" })
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>Clasificación Externa</label>
                                                    @Html.DropDownList("ddlClasificacionExterna", Model.ddlClasificacionExterna, new { @class = "select" })
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label>Comisiones de la operación</label>

                                                    <div class="table-responsive">
                                                        <table class="table table-bordered">
                                                            <thead>
                                                                <tr>
                                                                    <th width="10%">#</th>
                                                                    <th width="40%">Tipo</th>
                                                                    <th width="30%">Periodicidad</th>
                                                                    <th width="20%">Comisión</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td>1</td>
                                                                    <td>
                                                                        @Html.DropDownList("ddlComisionServicio", Model.ddlComisionServicio, new { @data_placeholder = "Comisión", @class = "select" })
                                                                    </td>
                                                                    <td>
                                                                        @Html.DropDownList("ddlPeriocidad", Model.ddlPeriocidad, new { @data_placeholder = "Periocidad", @class = "select" })
                                                                    </td>
                                                                    <td>
                                                                        <input type="text" value="100" class="form-control">
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td>2</td>
                                                                    <td>
                                                                        @Html.DropDownList("ddlComisionServicio2", Model.ddlComisionServicio, new { @data_placeholder = "Comisión", @class = "select" })
                                                                    </td>
                                                                    <td>
                                                                        @Html.DropDownList("ddlPeriocidad2", Model.ddlPeriocidad, new { @data_placeholder = "Periocidad", @class = "select" })
                                                                    </td>
                                                                    <td>
                                                                        <input type="text" value="100" class="form-control">
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                                <!-- /bordered table -->
                                            </div>
                                        </div>

                                        <legend class="tipografia1 text-semibold"><i class="icon-price-tag position-left"></i> Garantías</legend>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Real Mobiliaria</label>
                                                    @Html.DropDownList("ddlGarantiaReal", Model.ddlGarantiaReal, new { @class = "select" })
                                                </div>
                                            </div>

                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Monto Garantía:</label>
                                                    <input type="text" id="txtMontoGarantiaReal" name="txtMontoGarantiaReal" value="0" min="0" class="form-control">
                                                </div>
                                            </div>

                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Moneda:</label>
                                                    @Html.DropDownList("ddlMonedaReal", Model.ddlMoneda, new { @class = "select" })
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Personales y Derivadas</label>
                                                    @Html.DropDownList("ddlGarantiaPersonal", Model.ddlGarantiaPersonal, new { @class = "select" })
                                                </div>
                                            </div>

                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Monto Garantía:</label>
                                                    <input type="text" id="txtMontoGarantiaPersonal" name="txtMontoGarantiaPersonal" value="0" min="0" class="form-control">
                                                </div>
                                            </div>

                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Moneda:</label>
                                                    @Html.DropDownList("ddlMonedaPersonal", Model.ddlMoneda, new { @class = "select" })
                                                </div>
                                            </div>
                                        </div>


                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Rating del Garante</label>
                                                    @Html.DropDownList("ddlClasificacionGarantia", Model.ddlClasificacionGarantia, new { @class = "select" })
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Modelo RORAC</label>
                                                    <select id="ddlModeloRORAC" name="ddlModeloRORAC" class="select">
                                                        <option value="1" selected="selected">Modelo Estándar</option>
                                                        <option value="2">Modelo Básico IRB</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </fieldset>
                            </div>
                            

                            <div class="col-md-7">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="tabbable">
                                            <ul class="nav nav-tabs">

                                                <li class="active"> <a id="Seccion01" href="#basic-tab1" data-toggle="tab">Balance</a></li>
                                                <li>                <a id="Seccion02" href="#basic-tab2" data-toggle="tab">Diagrama Dispersión</a></li>
                                                <li>                <a id="Seccion03" href="#basic-tab3" data-toggle="tab">Gráfico de Composición</a></li>
                                            </ul>

                                            <div class="tab-content">
                                                <div class="tab-pane active" id="basic-tab1">
                                                    <fieldset>
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <div class="form-group">
                                                                    <div class="table-responsive">
                                                                        <table class="table tblRowsHeight">
                                                                            <thead>
                                                                                <tr class="headerTblColorPlomo tipografia1">
                                                                                    <th colspan="6" style="text-align:center;"><i class="icon-calculator2 position-left"></i> Contribución EGP (expresado en dólares)</th>
                                                                                </tr>
                                                                                <tr class="headerTblColorPlomo tipografia1">
                                                                                    <th align="right"></th>
                                                                                    <th style="text-align: right">Operación</th>
                                                                                    <th style="text-align: right">Anual</th>
                                                                                    <th style="text-align: right">Trimestral</th>
                                                                                    <th style="text-align: right">Mensual</th>
                                                                                    <th style="text-align: right">Tasa</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody id="tbodyPYG">
                                                                                @foreach (var item in Model.dataPYG)
                                                                                {
                                                                                    var trClass = "";
                                                                                    if (item.color.Equals("beige"))
                                                                                    {
                                                                                        trClass = "colorBeige";
                                                                                    }
                                                                                    if (item.color.Equals("gray"))
                                                                                    {
                                                                                        trClass = "colorGray";
                                                                                    }
                                                                                    <tr class="@trClass tipografia2">
                                                                                        <td align="left">@item.detalle</td>
                                                                                        <td align="right">@String.Format("{0:#,##0}", @item.operacion)</td>
                                                                                        <td align="right">@String.Format("{0:#,##0}", @item.anual)</td>
                                                                                        <td align="right">@String.Format("{0:#,##0}", @item.trimestral)</td>
                                                                                        <td align="right">@String.Format("{0:#,##0.00}", @item.mensual)</td>
                                                                                        <td align="right">@String.Format("{0:0.00%}", @item.ratio)</td>
                                                                                    </tr>

                                                                                }
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                                <!-- /bordered table -->
                                                            </div>
                                                        </div>

                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <div class="form-group">
                                                                    <div class="table-responsive">
                                                                        <table class="table tblRowsHeight">
                                                                            <thead>
                                                                                <tr class="headerTblColorPlomo tipografia1">
                                                                                    <th colspan="6" style="text-align:center;"><i class="icon-newspaper position-left"></i> Resumen de Escenarios</th>
                                                                                </tr>
                                                                                <tr class="headerTblColorPlomo tipografia1">
                                                                                    <th></th>
                                                                                    <th style="text-align: right">Operación</th>
                                                                                    <th style="text-align: right">Objetivo</th>
                                                                                    <th style="text-align: right">Riesgo</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody id="tbodyResEsc">
                                                                                @foreach (var item in Model.dataResEsc)
                                                                                {
                                                                                    var trClass = "";
                                                                                    if (item.color.Equals("beige"))
                                                                                    {
                                                                                        trClass = "colorBeige";
                                                                                    }
                                                                                    <tr class="@trClass tipografia2">
                                                                                        <td align="left">@item.detalle</td>
                                                                                        <td align="right">
                                                                                            @if (item.formato.Equals("%2"))
                                                                                            {
                                                                                                @String.Format("{0:0.00%}", @item.operacion)
                                                                                            }
                                                                                            else if (item.formato.Equals("%3"))
                                                                                            {
                                                                                                @String.Format("{0:0.000%}", @item.operacion)
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                @String.Format("{0:#,##0}", @item.operacion)
                                                                                            }
                                                                                        </td>
                                                                                        <td align="right">
                                                                                            @if (item.formato.Equals("%2"))
                                                                                            {
                                                                                                @String.Format("{0:0.00%}", item.objetivo)
                                                                                            }
                                                                                            else if (item.formato.Equals("%3"))
                                                                                            {
                                                                                                @String.Format("{0:0.000%}", item.objetivo)
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                @String.Format("{0:#,##0}", item.objetivo)
                                                                                            }
                                                                                        </td>
                                                                                        <td align="right">
                                                                                            @if (item.formato.Equals("%2"))
                                                                                            {
                                                                                                @String.Format("{0:0.00%}", item.primaRiesgo)
                                                                                            }
                                                                                            else if (item.formato.Equals("%3"))
                                                                                            {
                                                                                                @String.Format("{0:0.000%}", item.primaRiesgo)
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                @String.Format("{0:#,##0}", item.primaRiesgo)
                                                                                            }
                                                                                        </td>
                                                                                    </tr>
                                                                                }
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                                <!-- /bordered table -->
                                                            </div>
                                                        </div>


                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <div class="form-group">
                                                                    <div class="table-responsive">
                                                                        <table class="table tblRowsHeight">
                                                                            <tbody id="tbodyRoracRes">
                                                                                @foreach (var item in Model.dataRoracRes)
                                                                                {
                                                                                    var xClass = "";
                                                                                    if (item.estilo.Equals("TIT01"))
                                                                                    {
                                                                                        xClass = "colorPlomo";

                                                                                        <tr class="@xClass tipografia1"><td align="center" colspan="6" class="text-semibold">@item.detalle</td></tr>
                                                                                    }
                                                                                    else if (item.estilo.Equals("TIT02"))
                                                                                    {
                                                                                        //xClass = "borderWhite";
                                                                                        <tr class="tipografia1"><td align="center" colspan="6" class="text-semibold">@item.detalle</td></tr>
                                                                                    }
                                                                                    else if (item.estilo.Equals("") && item.detalle.Equals(""))
                                                                                    {
                                                                                        <tr><td colspan="6">&nbsp;</td></tr>
                                                                                    }
                                                                                    else if (item.estilo.Equals(""))
                                                                                    {
                                                                                        <tr><td colspan="6" class="text-semibold">@item.detalle</td></tr>
                                                                                    }
                                                                                    else if (item.estilo.Equals("NORMAL"))
                                                                                    {
                                                                                        <tr>
                                                                                            <td align="left">@item.detalle</td>
                                                                                            @if (item.formato.Equals("###,####,###"))
                                                                                            {
                                                                                                <td align="right">@String.Format("{0:#,##0}", @item.res01)</td>
                                                                                                <td align="right">@String.Format("{0:#,##0}", @item.res02)</td>
                                                                                                <td align="right">@String.Format("{0:#,##0}", @item.res03)</td>
                                                                                                <td align="right">@String.Format("{0:#,##0}", @item.res04)</td>
                                                                                                <td align="right">@String.Format("{0:#,##0}", @item.res05)</td>
                                                                                            }
                                                                                            else if (item.formato.Equals("##,##0.00%"))
                                                                                            {
                                                                                                <td align="right">@String.Format("{0:0.00%}", @item.res01)</td>
                                                                                                <td align="right">@String.Format("{0:0.00%}", @item.res02)</td>
                                                                                                <td align="right">@String.Format("{0:0.00%}", @item.res03)</td>
                                                                                                <td align="right">@String.Format("{0:0.00%}", @item.res04)</td>
                                                                                                <td align="right">@String.Format("{0:0.00%}", @item.res05)</td>
                                                                                            }
                                                                                        </tr>
                                                                                    }
                                                                                    else if (item.estilo.Equals("TIT05"))
                                                                                    {
                                                                                        xClass = "colorBeige";
                                                                                        <tr class="@xClass">
                                                                                            <td align="left">@item.detalle</td>
                                                                                            @if (item.formato.Equals("###,####,###"))
                                                                                            {
                                                                                                <td align="right">@String.Format("{0:#,##0}", @item.res01)</td>
                                                                                                <td align="right">@String.Format("{0:#,##0}", @item.res02)</td>
                                                                                                <td align="right">@String.Format("{0:#,##0}", @item.res03)</td>
                                                                                                <td align="right">@String.Format("{0:#,##0}", @item.res04)</td>
                                                                                                <td align="right">@String.Format("{0:#,##0}", @item.res05)</td>
                                                                                            }
                                                                                            else if (item.formato.Equals("##,##0.00%"))
                                                                                            {
                                                                                                <td align="right">@String.Format("{0:0.00%}", @item.res01)</td>
                                                                                                <td align="right">@String.Format("{0:0.00%}", @item.res02)</td>
                                                                                                <td align="right">@String.Format("{0:0.00%}", @item.res03)</td>
                                                                                                <td align="right">@String.Format("{0:0.00%}", @item.res04)</td>
                                                                                                <td align="right">@String.Format("{0:0.00%}", @item.res05)</td>
                                                                                            }
                                                                                        </tr>
                                                                                    }
                                                                                }
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                                <!-- /bordered table -->
                                                            </div>
                                                        </div>

                                                    </fieldset>
                                                </div>

                                                <div class="tab-pane" id="basic-tab2">
                                                    <fieldset>
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <div class="form-inline" style="margin-bottom:20px;">
                                                                    <div class="form-group">
                                                                        <select id="ddlRangoTasa" name="ddlRangoTasa" class="select">
                                                                            <option value="0.001" selected="selected">Tasa de 0.10%</option>
                                                                            <option value="0.0015">Tasa de 0.15%</option>
                                                                            <option value="0.0020">Tasa de 0.20%</option>
                                                                            <option value="0.0050">Tasa de 0.50%</option>
                                                                            <option value="0.01">Tasa de 1%</option>
                                                                            <option value="0.02">Tasa de 2.0%</option>
                                                                            <option value="0.03">Tasa de 3.0%</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <select id="ddlRangoPlazo" name="ddlRangoPlazo" class="select">
                                                                            <option value="1" selected="selected">Plazo de 1 mes</option>
                                                                            <option value="2">Plazo de 2 meses</option>
                                                                            <option value="3">Plazo de 3 meses</option>
                                                                            <option value="4">Plazo de 4 meses</option>
                                                                            <option value="5">Plazo de 5 meses</option>
                                                                            <option value="6">Plazo de 6 meses</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                <div class="hot-container">
                                                                    <div id="hot_alignment"></div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </fieldset>
                                                </div>

                                                <div class="tab-pane" id="basic-tab3">
                                                    <fieldset>
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <canvas id="myChart"></canvas>
                                                            </div>
                                                        </div>
                                                        <hr />
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <canvas id="myChart2"></canvas>
                                                            </div>
                                                        </div>
                                                        <hr />
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <canvas id="myChart3"></canvas>
                                                            </div>
                                                        </div>

                                                    </fieldset>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                
                            </div>


                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- /content area -->
    </div>
    <!-- /main content -->
</div>


<script type="text/javascript">
    $(document).ready(function () {

        var jsModel = @Html.Raw(Json.Encode(Model));
        var dataHot = [
            { col0: '', col1: 'RORAC Bajo Modelo Estándar', col2: '', col3: '', col4: '', col5: '', col6: '', col7: '', col8: '', col9: '', col10: '' },
            { col0: '(Plazo en  Meses de la Operación)', col1: '(Tasa efectiva Anual de La Operación)', col2: '', col3: '', col4: '', col5: '', col6: '', col7: '', col8: '', col9: '', col10: '' },
        ];
        var roracMenosObjetivo = jsModel.dataRorac.rorac_objetivo - jsModel.dataRorac.autonomia_comercial;
        $.each(jsModel.dataRoracTbl, function (index, item) {
            var feed = {
                col0: '', col1: item.plazo, col2: numeral(item.valor1).format('0.00%'), col3: numeral(item.valor2).format('0.00%')
                , col4: numeral(item.valor3).format('0.00%'), col5: numeral(item.valor4).format('0.00%')
                , col6: numeral(item.valor5).format('0.00%'), col7: numeral(item.valor6).format('0.00%')
                , col8: numeral(item.valor7).format('0.00%'), col9: numeral(item.valor8).format('0.00%')
                , col10: numeral(item.valor9).format('0.00%')
            };
            dataHot.push(feed)
        });
        // Define element
        var hot_alignment = document.getElementById('hot_alignment');
        // Initialize with options
        var hot_alignment_init = new Handsontable(hot_alignment, {
            data: dataHot,
            rowHeaders: false,
            colHeaders: false,
            //rowHeights: 23,
            //colWidths: 100,
            licenseKey: 'non-commercial-and-evaluation',
            colWidths: [30, 30, 80, 80, 80, 80, 80, 80, 80, 80, 80],
            //rowHeight: function (row) {
            //    if (row == 0) {
            //        return 10;
            //    } else {
            //        return 50;
            //    }

            //},
            //contextMenu: true,
            autoWrapRow: true,
            autoWrapCol: true,
            /*stretchH: 'all',*/
            mergeCells: [
                { row: 0, col: 1, rowspan: 1, colspan: 10 },
                { row: 1, col: 0, rowspan: 11, colspan: 1 },
                { row: 1, col: 1, rowspan: 1, colspan: 10 }
            ],
            className: "htRight",
            //colHeaders: ['ID', 'Name', 'IP', 'E-mail'],
            columns: [
                { data: 'col0' },
                { data: 'col1', className: 'htLeft' },
                { data: 'col2' },
                { data: 'col3' },
                { data: 'col4' },
                { data: 'col5' },
                { data: 'col6' },
                { data: 'col7' },
                { data: 'col8' },
                { data: 'col9' },
                { data: 'col10' },
            ],
        });
        hot_alignment_init.updateSettings({
            cells: function (row, col, prop) {
                var cell = hot_alignment_init.getCell(row, col);   // get the cell for the row and column
                if (cell != undefined && cell != null) {
                    if ((row == 0 && col == 0) || (row == 0 && col == 1) || (row == 1 && col == 0) || (row == 1 && col == 1)) {
                        cell.style.backgroundColor = "#54585b"; // plomo
                        cell.style.borderColor = "#54585b";
                        cell.style.color = "white";
                        //cell.style.align = "center";
                    }
                    if (row == 1 && col == 0) {
                        cell.style.overflowWrap = "break-word";
                        cell.style.writingMode = "vertical-rl";
                        cell.style.textAlign = "center";
                    }
                    if (row > 2 && col > 1) {
                        var value = parseFloat(cell.innerHTML) / 100.0;
                        if (value <= 0) { // regla rojo
                            cell.style.backgroundColor = "#812b2e";
                            cell.style.borderColor = "#812b2e";
                            cell.style.color = "white";
                        } else if (value > 0 && value < roracMenosObjetivo) { // regla beige
                            cell.style.backgroundColor = "#969076";
                            cell.style.borderColor = "#969076";
                        } else if (value >= roracMenosObjetivo && value < jsModel.dataRorac.rorac_objetivo) { // regla blanco
                            cell.style.backgroundColor = "white";
                            cell.style.borderColor = "white";
                            cell.style.color = "black";
                        } else if (value >= jsModel.dataRorac.rorac_objetivo) { // regla azul
                            cell.style.backgroundColor = "#222840";
                            cell.style.borderColor = "#222840";
                            cell.style.color = "white";
                        }

                    }
                }
                
            }
        });

        $("#btnNuevo").on("click", function () {
            // limpiar controles
            $('input:text').val('');
        });

        $("#btnEditar").on("click", function () {
            $('#editModal').modal('show');    ;
        });

        $("#btnGrabar").on("click", function () {
            grabar();
        });

        $('#txtMonto,#txtMontoGarantiaReal,#txtMontoGarantiaPersonal').inputmask({
            'alias': 'decimal',
            'groupSeparator': ',',
            'autoGroup': true,
            'digits': 2,
            'digitsOptional': false,
            'placeholder': '0.00'
        });

        $("#txtTasaEfectiva").inputmask({
            alias: "decimal",
            radixPoint: ".",
            digits: "2",
            rightAlign: false,
            integerDigits: 5,
            digitsOptional: true,
            allowPlus: true,
            allowMinus: true,
            placeholder: "0",
            min: 0,
            max: 100,
            numericInput: true
        });

        var codProducto = $("#ddlProducto option:selected").val();
        //productoAmortizacion(codProducto);

        function getPorcentaje(valor) {
            let tasa = Number(valor);
            if (tasa == 0) {
                return 0;
            }
            return tasa / 100.0;
        }

        function getImporte(valor) {
            let monto = Number(valor.replace(/,/g, ''));
            return monto;
        }

        function productoAmortizacion(codProducto) {
            if ($("#ddlOperacion option:selected").val() == "DEP") {
                $("#ddlAmortizacion").val(6).change();
                return;
            }
            if (codProducto == 1040 || codProducto == 1041 || codProducto == 1042 || codProducto == 1060 || codProducto == 1043 || codProducto == 1044 || codProducto == 1100) {
                $("#ddlAmortizacion").val(1).change();
            }
            if (codProducto == 1010 || codProducto == 1020 || codProducto == 1021 || codProducto == 1022 || codProducto == 3010 || codProducto == 3020) {
                $("#ddlAmortizacion").val(3).change();
            }
            if (codProducto == 1030 || codProducto == 1035) {
                $("#ddlAmortizacion").val(4).change();
            }
            if (codProducto == 1045 || codProducto == 2010 || codProducto == 2020 || codProducto == 2030 || codProducto == 3030) {
                $("#ddlAmortizacion").val(5).change();
            }

        }

        function grabar() {

            let monto = getImporte($("#txtMonto").val());
            let tea = getPorcentaje($("#txtTasaEfectiva").val());
            let plazo = Number($("#txtPlazoMeses").val());
            let tipoDoc = $("#ddlTipDocumento option:selected").val();
            let numDoc = $("#txtNumDoc").val();
            /*
            if (tipoDoc == 1) { // ruc
                if (numDoc.length != 11) {
                    toastr.warning('RUC debe contener 11 dígitos');
                    return;
                }
            }
            if (tipoDoc == 2) { // dni
                if (numDoc.length != 8) {
                    toastr.warning('DNI debe contener 8 dígitos');
                    return;
                }
            }

            if (monto == 0) {
                toastr.warning('Ingresar valor monto');
                return;
            }
            if (tea == 0) {
                toastr.warning('Ingresar valor tea');
                return;
            }
            if (plazo == 0) {
                toastr.warning('Ingresar valor plazo meses');
                return;
            }
            */

            $("#overlay").show();
            var _obj = {
                accion: '@@GRABAR',
                ide_cliente: 1,
                cod_tip_documento: tipoDoc,
                num_documento: numDoc,
                nom_cliente: $("#txtNombreCliente").val(),
                cod_personeria: $("#ddlPersoneria option:selected").val(),
                cod_tip_cliente: $("#ddlTipCliente option:selected").val(),
                cod_tip_prospecto: $('input:radio[name=rbTipProspecto]:checked').val(),
                ide_cliente_producto: 1,
                cod_producto: $("#ddlProducto option:selected").val(),
                cod_operacion: $("#ddlOperacion option:selected").val(),
                cod_moneda: $("#ddlMoneda option:selected").val(),
                monto: monto,
                cod_canal_atencion: $("#ddlCanalAtencion").val(),
                tea: tea,
                plazo: plazo,
                cod_clasificacion_interna: $("#ddlClasificacionInterna option:selected").val(),
                cod_clasificacion_externa: $("#ddlClasificacionExterna option:selected").val(),
                cod_garantia_real: $("#ddlGarantiaReal option:selected").val(),
                cod_moneda_garantia_real: $("#ddlMonedaReal option:selected").val(),
                monto_garantia_real: getImporte($("#txtMontoGarantiaReal").val()),
                cod_garantia_personal: $("#ddlGarantiaPersonal option:selected").val(),
                cod_moneda_garantia_personal: $("#ddlMonedaPersonal option:selected").val(),
                monto_garantia_personal: getImporte($("#txtMontoGarantiaPersonal").val()),
                cod_clasificacion_garantia: $("#ddlClasificacionGarantia option:selected").val(),
                cod_modelo_rorac: $("#ddlModeloRORAC option:selected").val(),
                ide_usuario: 1,
                incremento_tasa: $("#ddlRangoTasa option:selected").val(),
                incremento_plazo: $("#ddlRangoPlazo option:selected").val(),
            };

            var _reply = {
                ACCION: '@@GRABAR',
                MENSAJE: '',
                IDE_USUARIO: 0,
                DATA: JSON.stringify(_obj),
            };

            var _url = '@Url.Action("Edit", "REN")';

            $.post(_url, _reply).done(function (data) {
                if (data.Status === 200) {
                    //toastr.success(data.Message);
                    // reconstruir reportes
                    reconstruirReportePYG(data.Data);
                    reconstruirReporteResumenEscenario(data.Data);
                    reconstruirReporteRoracRes(data.Data);
                    reconstruirHandsontable(data.Data);
                    updateChart1(data.Data.dataComposicion);
                    updateChart2(data.Data.dataComposicion);
                    updateChart3(data.Data.dataComposicion);

                    $("#txtAmortizacion").val(data.Data.amortizacion.Text);
                }
                else {
                    toastr.error(data.Message);
                }
                $("#overlay").hide();
            });
        }

        function reconstruirReportePYG(data) {
            $("#tbodyPYG").empty();
            var cadena = "";
            $.each(data.dataPYG, function (index, item) {
                var trClass = "";
                if (item.color == "beige") {
                    trClass = "colorBeige";
                }
                cadena += "<tr class=" + trClass +">";
                cadena += "<td align='left'>" + item.detalle + "</td>";
                cadena += "<td align='right'>" + numeral(item.operacion).format('0,0') + "</td>";
                cadena += "<td align='right'>" + numeral(item.anual).format('0,0') + "</td>";
                cadena += "<td align='right'>" + numeral(item.trimestral).format('0,0') + "</td>";
                cadena += "<td align='right'>" + numeral(item.mensual).format('0,0.00') + "</td>";
                cadena += "<td align='right'>" + numeral(item.ratio).format('0.00%') + "</td>";
                cadena += "</tr>";
            });
            $("#tbodyPYG").append(cadena);
        }

        function reconstruirReporteResumenEscenario(data) {
            $("#tbodyResEsc").empty();
            var cadena = "";
            $.each(data.dataResEsc, function (index, item) {
                var trClass = "";
                if (item.color == "beige") {
                    trClass = "colorBeige";
                }
                var _numOpe = 0;
                var _numObj = 0;
                var _numPrima = 0;

                if (item.formato == "%2")
                {
                    _numOpe = numeral(item.operacion).format('0.00%');
                    _numObj = numeral(item.objetivo).format('0.00%');
                    _numPrima = numeral(item.primaRiesg).format('0.00%');
                }
                else if (item.formato == "%3")
                {
                    _numOpe = numeral(item.operacion).format('0.000%');
                    _numObj = numeral(item.objetivo).format('0.000%');
                    _numPrima = numeral(item.primaRiesg).format('0.000%');
                }
                else
                {
                    _numOpe = numeral(item.operacion).format('0,0');
                    _numObj = numeral(item.objetivo).format('0,0');
                    _numPrima = numeral(item.primaRiesg).format('0,0');
                }

                cadena += "<tr class=" + trClass+">";
                cadena += "<td align='left'>" + item.detalle + "</td>";
                cadena += "<td align='right'>" + _numOpe + "</td>";
                cadena += "<td align='right'>" + _numObj + "</td>";
                cadena += "<td align='right'>" + _numPrima + "</td>";;
                cadena += "</tr>";
            });
            $("#tbodyResEsc").append(cadena);
        }

        function reconstruirReporteRoracRes(data) {
            $("#tbodyRoracRes").empty();
            var cadena = "";
            $.each(data.dataRoracRes, function (index, item) {
                if (item.estilo == "TIT01" || item.estilo == "TIT02") {
                    cadena += "<tr class='colorPlomo'><td align='center' colspan='6' class='text-semibold'>"+item.detalle+"</td></tr>";
                } else if (item.estilo == "" && item.detalle == "") {
                    cadena += "<tr><td colspan='6'>&nbsp;</td></tr>";
                } else if (item.estilo == ""){
                    cadena += "<tr><td colspan='6' class='text-semibold'>"+item.detalle+"</td></tr>";
                } else if (item.estilo == "NORMAL") {
                    cadena += "<tr>";
                    cadena += "<td align='left'>" + item.detalle + "</td>";
                    if (item.formato == "###,####,###") {
                        cadena += "<td align='right'>" + numeral(item.res01).format('0,0') + "</td>";
                        cadena += "<td align='right'>" + numeral(item.res02).format('0,0') + "</td>";
                        cadena += "<td align='right'>" + numeral(item.res03).format('0,0') + "</td>";
                        cadena += "<td align='right'>" + numeral(item.res04).format('0,0') + "</td>";
                        cadena += "<td align='right'>" + numeral(item.res05).format('0,0') + "</td>";
                    } else if (item.formato == "##,##0.00%") {
                        cadena += "<td align='right'>" + numeral(item.res01).format('0.00%') + "</td>";
                        cadena += "<td align='right'>" + numeral(item.res02).format('0.00%') + "</td>";
                        cadena += "<td align='right'>" + numeral(item.res03).format('0.00%') + "</td>";
                        cadena += "<td align='right'>" + numeral(item.res04).format('0.00%') + "</td>";
                        cadena += "<td align='right'>" + numeral(item.res05).format('0.00%') + "</td>";
                    }
                    cadena += "</tr>";
                } else if (item.estilo == "TIT05") {
                    cadena += "<tr class='colorBeige'>";
                    cadena += "<td align='left'>" + item.detalle + "</td>";
                    if (item.formato == "###,####,###") {
                        cadena += "<td align='right'>" + numeral(item.res01).format('0,0') + "</td>";
                        cadena += "<td align='right'>" + numeral(item.res02).format('0,0') + "</td>";
                        cadena += "<td align='right'>" + numeral(item.res03).format('0,0') + "</td>";
                        cadena += "<td align='right'>" + numeral(item.res04).format('0,0') + "</td>";
                        cadena += "<td align='right'>" + numeral(item.res05).format('0,0') + "</td>";
                    } else if (item.formato == "##,##0.00%") {
                        cadena += "<td align='right'>" + numeral(item.res01).format('0.00%') + "</td>";
                        cadena += "<td align='right'>" + numeral(item.res02).format('0.00%') + "</td>";
                        cadena += "<td align='right'>" + numeral(item.res03).format('0.00%') + "</td>";
                        cadena += "<td align='right'>" + numeral(item.res04).format('0.00%') + "</td>";
                        cadena += "<td align='right'>" + numeral(item.res05).format('0.00%') + "</td>";
                    }
                    cadena += "</tr>";
                }

            });
            $("#tbodyRoracRes").append(cadena);
        }

        function reconstruirHandsontable(data) {
            if (hot_alignment_init) {
                var dataHot = [
                    { col0: '', col1: 'RORAC Bajo Modelo Estándar', col2: '', col3: '', col4: '', col5: '', col6: '', col7: '', col8: '', col9: '', col10: '' },
                    { col0: '(Plazo en  Meses de la Operación)', col1: '(Tasa efectiva Anual de La Operación)', col2: '', col3: '', col4: '', col5: '', col6: '', col7: '', col8: '', col9: '', col10: '' },
                ];

                $.each(data.dataRoracTbl, function (index, item) {
                    var feed = {
                        col0: '', col1: item.plazo, col2: numeral(item.valor1).format('0.00%'), col3: numeral(item.valor2).format('0.00%')
                        , col4: numeral(item.valor3).format('0.00%'), col5: numeral(item.valor4).format('0.00%')
                        , col6: numeral(item.valor5).format('0.00%'), col7: numeral(item.valor6).format('0.00%')
                        , col8: numeral(item.valor7).format('0.00%'), col9: numeral(item.valor8).format('0.00%')
                        , col10: numeral(item.valor9).format('0.00%')
                    };
                    dataHot.push(feed)
                });

                hot_alignment_init.loadData(dataHot);
                hot_alignment_init.render();
                return;
            }
        }

        $("#ddlModeloRORAC,#ddlPersoneria,#ddlTipCliente,#ddlOperacion,#ddlProducto,#ddlMoneda,#txtMonto,#ddlCanalAtencion,#txtTasaEfectiva,#txtPlazoMeses,#ddlClasificacionInterna,#ddlGarantiaReal,#ddlMonedaReal,#txtMontoGarantiaReal,#ddlMonedaPersonal,#txtMontoGarantiaPersonal,#ddlClasificacionGarantia").change(function () {
            grabar();
        });

        $("#ddlRangoTasa, #ddlRangoPlazo").change(function () {
            $("#overlay").show();
            $.getJSON('@Url.Action("JSON_ReporteRORACModelo")', { incremento_tasa: $("#ddlRangoTasa option:selected").val(), incremento_plazo: $("#ddlRangoPlazo option:selected").val() }, function (data) {
                reconstruirHandsontable(data);
            });
            $("#overlay").hide();
        });

        $("#ddlPersoneria").change(function () {
            $.getJSON('@Url.Action("JSON_PersoneriaChange")', { codPersoneria: $("#ddlPersoneria option:selected").val() }, function (data) {

                $('#ddlTipDocumento').empty();
                $.each(data.ddlTipDocumento, function (index, item) {
                    $('#ddlTipDocumento').append($('<option/>', {
                        value: item.Value,
                        text: item.Text,
                        selected: item.Selected
                    }));
                });

                $('#ddlTipCliente').empty();
                $.each(data.ddlTipCliente, function (index, item) {
                    $('#ddlTipCliente').append($('<option/>', {
                        value: item.Value,
                        text: item.Text,
                        selected: item.Selected
                    }));
                });
            });
        });

        $("#ddlOperacion").change(function () {
            $.getJSON('@Url.Action("JSON_OperacionChange")', { codOperacion: $("#ddlOperacion option:selected").val() }, function (data) {

                $('#ddlProducto').empty();
                $.each(data.ddlProducto, function (index, item) {
                    $('#ddlProducto').append($('<option/>', {
                        value: item.Value,
                        text: item.Text,
                        selected: item.Selected
                    }));
                });

                $('#ddlClasificacionInterna').empty();
                $.each(data.ddlClasificacionInterna, function (index, item) {
                    $('#ddlClasificacionInterna').append($('<option/>', {
                        value: item.Value,
                        text: item.Text,
                        selected: item.Selected
                    }));
                });
                $('#ddlClasificacionExterna').empty();
                $.each(data.ddlClasificacionExterna, function (index, item) {
                    $('#ddlClasificacionExterna').append($('<option/>', {
                        value: item.Value,
                        text: item.Text,
                        selected: item.Selected
                    }));
                });

                $("#txtAmortizacion").val(data.amortizacion.Text);

                $('#ddlGarantiaReal').empty();
                $.each(data.ddlGarantiaReal, function (index, item) {
                    $('#ddlGarantiaReal').append($('<option/>', {
                        value: item.Value,
                        text: item.Text,
                        selected: item.Selected
                    }));
                });
                $('#ddlGarantiaPersonal').empty();
                $.each(data.ddlGarantiaPersonal, function (index, item) {
                    $('#ddlGarantiaPersonal').append($('<option/>', {
                        value: item.Value,
                        text: item.Text,
                        selected: item.Selected
                    }));
                });
                $('#ddlClasificacionGarantia').empty();
                $.each(data.ddlClasificacionGarantia, function (index, item) {
                    $('#ddlClasificacionGarantia').append($('<option/>', {
                        value: item.Value,
                        text: item.Text,
                        selected: item.Selected
                    }));
                });

                let disabled = false;
                if ($("#ddlOperacion option:selected").val() == "DEP") {
                    disabled = true;
                    $('#txtMontoGarantiaReal').empty();
                    $('#txtMontoGarantiaPersonal').empty();
                }
                $('#ddlGarantiaReal').prop('disabled', disabled);
                $('#ddlGarantiaPersonal').prop('disabled', disabled);
                $('#ddlClasificacionGarantia').prop('disabled', disabled);
                $('#txtMontoGarantiaReal').prop('disabled', disabled);
                $('#txtMontoGarantiaPersonal').prop('disabled', disabled);
                $('#ddlMonedaReal').prop('disabled', disabled);
                $('#ddlMonedaPersonal').prop('disabled', disabled);


                //productoAmortizacion($("#ddlProducto option:selected").val());
            });
        });

        $("#ddlProducto").change(function () {
            $.getJSON('@Url.Action("JSON_ComisionServicioChange")', { codProducto: $("#ddlProducto option:selected").val() }, function (data) {

                $('#ddlComisionServicio,#ddlComisionServicio2').empty();
                $.each(data.ddlComisionServicio, function (index, item) {
                    $('#ddlComisionServicio,#ddlComisionServicio2').append($('<option/>', {
                        value: item.Value,
                        text: item.Text,
                        selected: item.Selected
                    }));
                });

                productoAmortizacion($("#ddlProducto option:selected").val());
            });
        });

        function updateChart1(data) {
            var dat = data.filter(a => a.tipo == 1);
            var labels = dat.map(x => x.detalle);
            var values = dat.map(x => x.valor);

            myChart.data.labels = labels;
            myChart.data.datasets.forEach((dataset) => {
                dataset.data = values;
            });
            myChart.update();
        }
        function updateChart2(data) {
            var dat = data.filter(a => a.tipo == 2);
            var labels = dat.map(x => x.detalle);
            var values = dat.map(x => x.valor);

            myChart2.data.labels = labels;
            myChart2.data.datasets.forEach((dataset) => {
                dataset.data = values;
            });
            myChart2.update();
        }
        function updateChart3(data) {
            var dat = data.filter(a => a.tipo == 3);
            var labels = dat.map(x => x.detalle);
            var values = dat.map(x => x.valor);

            myChart3.data.labels = labels;
            myChart3.data.datasets.forEach((dataset) => {
                dataset.data = values;
            });
            myChart3.update();
        }

        const totalizer = {
            id: 'totalizer',
            beforeUpdate: chart => {
                let totals = {}
                let utmost = 0

                chart.data.datasets.forEach((dataset, datasetIndex) => {
                    if (chart.isDatasetVisible(datasetIndex)) {
                        utmost = datasetIndex
                        dataset.data.forEach((value, index) => {
                            totals[index] = (totals[index] || 0) + value
                        })
                    }
                })
                chart.$totalizer = {
                    totals: totals,
                    utmost: utmost
                }
            }
        }


        Chart.defaults.font.size = 10;
        Chart.defaults.font.family = "Poppins";
        Chart.register(ChartDataLabels);
        var dataComposicion = jsModel.dataComposicion
        var compOPE = dataComposicion.filter(a => a.tipo == 1);
        var labelsOPE = compOPE.map(x => x.detalle);
        var valuesOPE = compOPE.map(x => x.valor);
        var invOPE = compOPE.map(x => x.invisible);
        var negOPE = compOPE.map(x => x.negativo);

        const ctx = document.getElementById('myChart');
        ctx.height = 300;
        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labelsOPE,
                datasets: [
                    /*{
                        label: '# de Votos',
                        backgroundColor: ["#969076", "#969076", "#969076", "#969076", "#969076", "#969076", "#812b2e"],
                        data: valuesOPE,
                        borderWidth: 1,
                    },*/
                    { 
                        //label: '#', 
                        //backgroundColor: ["#D2BB8B", "#D2BB8B", "#D2BB8B", "#D2BB8B", "#D2BB8B", "#D2BB8B", "#969076"], 
                        data: invOPE, //[0.10, 0.10, 0.10, 0.10, 0.10, 0.10], 
                        borderWidth: 1,
                        //pointRadius: 0,
                        //borderColor: "#0000ff",
                        backgroundColor: "rgba(255, 10, 13, 0.1)",
                    }, { 
                        //label: '#', 
                        backgroundColor: ["#D2BB8B", "#D2BB8B", "#D2BB8B", "#D2BB8B", "#D2BB8B", "#D2BB8B", "#969076"], 
                        data: negOPE, //[0.01, 0.02, 0.03, 0.04, 0.05, 0.06], 
                        borderWidth: 1,
                    },   
                    /*{
                        label: 'Total',
                        data: [0, 0, 0, 0, 0, 0, 0],
                    }*/
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Composición Pricing de la Operación',
                        font: {
                            size: 14
                        }
                    },
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        enabled: false,
                    },
                    datalabels: {
                        align: 'end',
                        anchor: 'end',
                        color: 'black', 
                        font: {
                            weight: 'bold',
                        },
                        formatter: (value, ctx) => {
                            //const total = ctx.chart.$totalizer.totals[ctx.dataIndex];
                            //const _tot = (total * 100).toFixed(2) + '%';
                            //return _tot; //total.toLocaleString('fr-FR', {});
                            return (value * 100).toFixed(2) + '%';
                        },
                        display: function (ctx) {
                            return ctx.datasetIndex === ctx.chart.$totalizer.utmost
                        },
                        //color: 'rgba(255,255,255)', 
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                      },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        max: .2,
                        min: 0,
                        ticks: {
                            stepSize: .050,
                            callback: function (value, ctx) {
                                return (value * 100).toFixed(0) + '%';
                            },
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Percentage',
                        },
                    },
                },
            },
            plugins: [totalizer],
        });

        var compOBJ = dataComposicion.filter(a => a.tipo == 2);
        var labelsOBJ = compOBJ.map(x => x.detalle);
        var valuesOBJ = compOBJ.map(x => x.valor);
        var invOBJ = compOBJ.map(x => x.invisible);
        var negOBJ = compOBJ.map(x => x.negativo);

        const ctx2 = document.getElementById('myChart2');
        ctx2.height = 300;
        var myChart2 = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: labelsOBJ,
                datasets: [
                    /*
                    {
                        label: '# de Votos',
                        backgroundColor: ["#969076", "#969076", "#969076", "#969076", "#969076", "#969076", "#222840"],
                        data: valuesOBJ,
                        borderWidth: 1,
                    }*/
                    { 
                        backgroundColor: ["#3461A8", "#3461A8", "#3461A8", "#3461A8", "#3461A8", "#3461A8", "#969076"], 
                        data: invOBJ,
                        borderWidth: 1,
                        backgroundColor: "rgba(255, 10, 13, 0.1)",
                    }, 
                    {  
                        backgroundColor: "#3461A8", 
                        data: negOBJ, 
                        borderWidth: 1,
                    },   
                    //{
                        //label: 'Total',
                        //data: [0, 0, 0, 0, 0, 0, 0],
                    //}
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Composición Pricing Objetivo',
                        font: {
                            size: 14,
                        }
                    },
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        enabled: false,
                    },
                    datalabels: {
                        align: 'end',
                        anchor: 'end',
                        color: 'black', 
                        font: {
                            weight: 'bold',
                        },
                        formatter: (value, ctx) => {
                            //const total = ctx.chart.$totalizer.totals[ctx.dataIndex];
                            //const _tot = (total * 100).toFixed(2) + '%';
                            //return _tot; //total.toLocaleString('fr-FR', {});
                            return (value * 100).toFixed(2) + '%';
                        },
                        display: function (ctx) {
                            return ctx.datasetIndex === ctx.chart.$totalizer.utmost
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        max: .2,
                        min: 0,
                        ticks: {
                            stepSize: .050,
                            callback: function (value) {
                                return (value * 100).toFixed(0) + '%';
                            },
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Percentage',
                        },
                    },
                },
            },
            plugins: [totalizer]
        });

        var compRIE = dataComposicion.filter(a => a.tipo == 3);
        var labelsRIE = compRIE.map(x => x.detalle);
        var valuesRIE = compRIE.map(x => x.valor);
        var invRIE = compRIE.map(x => x.invisible);
        var negRIE = compRIE.map(x => x.negativo);

        const ctx3 = document.getElementById('myChart3');
        ctx3.height = 300;
        var myChart3 = new Chart(ctx3, {
            type: 'bar',
            data: {
                labels: labelsRIE,
                datasets: [
                    /*
                    {
                        label: '# de Votos',
                        backgroundColor: ["#969076", "#969076", "#969076", "#969076", "#d9d9d9"],
                        data: valuesRIE,
                        borderWidth: 1,
                    }*/
                    { 
                        backgroundColor: ["#A4343A", "#A4343A", "#A4343A", "#A4343A", "#A4343A", "#A4343A", "#969076"], 
                        data: invRIE,
                        borderWidth: 1,
                        backgroundColor: "rgba(255, 10, 13, 0.1)",
                    }, 
                    { 
                        backgroundColor: "#A4343A", 
                        data: negRIE, 
                        borderWidth: 1,
                    },
                    //{
                        //label: 'Total',
                        //data: [0, 0, 0, 0, 0, 0, 0],
                    //}
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Composición Pricing modelo Prima de Riesgo',
                        font: {
                            size: 14,
                        }
                    },
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        enabled: false,
                    },
                    datalabels: {
                        align: 'end',
                        anchor: 'end',
                        color: 'black', 
                        font: {
                            weight: 'bold',
                        },
                        formatter: (value, ctx) => {
                            //const total = ctx.chart.$totalizer.totals[ctx.dataIndex];
                            //const _tot = (total * 100).toFixed(2) + '%';
                            //return _tot; //total.toLocaleString('fr-FR', {});
                            return (value * 100).toFixed(2) + '%';
                        },
                        display: function (ctx) {
                            return ctx.datasetIndex === ctx.chart.$totalizer.utmost
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        max: .2,
                        min: 0,
                        ticks: {
                            stepSize: .050,
                            callback: function (value) {
                                return (value * 100).toFixed(0) + '%';
                            },
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Percentage',
                        },
                    },
                },
            },
            plugins: [totalizer]
        });
    });



</script>
